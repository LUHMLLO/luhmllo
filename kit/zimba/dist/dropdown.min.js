// deno-lint-ignore-file
var m=Object.defineProperty;var u=(s,t,e)=>t in s?m(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var o=(s,t,e)=>u(s,typeof t!="symbol"?t+"":t,e);function b(s,t){let e;return function(...n){e||(s.apply(this,n),e=!0,setTimeout(()=>e=!1,t))}}var v=class{constructor(t,e,n={}){o(this,"detailsElement");o(this,"dropdownContent");o(this,"trigger");o(this,"options");o(this,"resizeObserver");o(this,"mutationObserver");o(this,"clickOutsideHandler");o(this,"toggleHandler");o(this,"handleUpdatePosition");o(this,"isDestroyed",!1);o(this,"originalParent",null);o(this,"originalNextSibling",null);o(this,"isPortaled",!1);if(this.detailsElement=t,this.dropdownContent=e,this.trigger=t.querySelector("summary"),!this.trigger)throw new Error("DropdownAnchor: No <summary> element found in <details>");this.options={preferredY:"bottom",preferredX:"left",viewportMargin:5,gap:5,animated:!0,portal:!1,portalTo:document.body,...n},this.clickOutsideHandler=this.handleClickOutside.bind(this),this.toggleHandler=this.handleToggle.bind(this),this.handleUpdatePosition=this.updatePosition.bind(this),this.initializeDropdown(),this.setupObservers()}initializeDropdown(){this.options.animated||(this.dropdownContent.style.transition="none"),this.options.portal&&(this.originalParent=this.dropdownContent.parentElement,this.originalNextSibling=this.dropdownContent.nextElementSibling),this.detailsElement.addEventListener("toggle",this.toggleHandler),this.detailsElement.open&&requestAnimationFrame(()=>this.handleUpdatePosition())}enablePortal(){!this.options.portal||this.isPortaled||(this.options.portalTo.appendChild(this.dropdownContent),this.isPortaled=!0)}disablePortal(){!this.options.portal||!this.isPortaled||!this.originalParent||(this.originalNextSibling?this.originalParent.insertBefore(this.dropdownContent,this.originalNextSibling):this.originalParent.appendChild(this.dropdownContent),this.isPortaled=!1)}handleToggle(t){this.detailsElement.open?(this.enablePortal(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.handleUpdatePosition()})}),document.addEventListener("click",this.clickOutsideHandler)):(document.removeEventListener("click",this.clickOutsideHandler),this.disablePortal())}handleClickOutside(t){let e=t.target;!this.detailsElement.contains(e)&&!this.dropdownContent.contains(e)&&(this.detailsElement.open=!1)}calculatePosition(){let t=this.trigger.getBoundingClientRect(),e=this.dropdownContent.getBoundingClientRect(),n={width:globalThis.innerWidth,height:globalThis.innerHeight},i=0,r=0,h=this.options.preferredY,l=this.options.preferredX,a=e.width>0?e.width:200,p=e.height>0?e.height:200,c=n.height-t.bottom-this.options.viewportMargin,g=t.top-this.options.viewportMargin;switch(this.options.preferredY==="bottom"?c>=p+this.options.gap?(r=t.bottom+this.options.gap,h="bottom"):g>=p+this.options.gap?(r=t.top-p-this.options.gap,h="top"):c>g?(r=t.bottom+this.options.gap,h="bottom"):(r=Math.max(this.options.viewportMargin,t.top-p-this.options.gap),h="top"):g>=p+this.options.gap?(r=t.top-p-this.options.gap,h="top"):(r=t.bottom+this.options.gap,h="bottom"),this.options.preferredX){case"left":if(i=t.left,i+a>n.width-this.options.viewportMargin){let d=t.right-a;d>=this.options.viewportMargin?(i=d,l="right"):(i=n.width-a-this.options.viewportMargin,l="right")}break;case"right":if(i=t.right-a,i<this.options.viewportMargin){let d=t.left;d+a<=n.width-this.options.viewportMargin?(i=d,l="left"):(i=this.options.viewportMargin,l="left")}break;case"center":i=t.left+(t.width-a)/2,i<this.options.viewportMargin?(i=this.options.viewportMargin,l="left"):i+a>n.width-this.options.viewportMargin?(i=n.width-a-this.options.viewportMargin,l="right"):l="center";break}return i=Math.max(this.options.viewportMargin,Math.min(i,n.width-a-this.options.viewportMargin)),r=Math.max(this.options.viewportMargin,Math.min(r,n.height-p-this.options.viewportMargin)),{x:i,y:r,placement:{vertical:h,horizontal:l}}}updatePosition(){if(!this.detailsElement.open||this.isDestroyed)return;let t=this.calculatePosition();this.dropdownContent.style.setProperty("--translate-y",`${t.y}px`),this.dropdownContent.style.setProperty("--translate-x",`${t.x}px`)}setupObservers(){let t=b(this.handleUpdatePosition,16);globalThis.addEventListener("scroll",t,{passive:!0}),globalThis.addEventListener("resize",t,{passive:!0}),globalThis.ResizeObserver&&(this.resizeObserver=new ResizeObserver(()=>{this.detailsElement.open&&this.handleUpdatePosition()}),this.resizeObserver.observe(this.dropdownContent),this.resizeObserver.observe(this.trigger)),globalThis.MutationObserver&&(this.mutationObserver=new MutationObserver(()=>{this.detailsElement.open&&setTimeout(this.handleUpdatePosition,10)}),this.mutationObserver.observe(this.dropdownContent,{childList:!0,subtree:!0,attributes:!1}))}open(){this.isDestroyed||(this.detailsElement.open=!0)}close(){this.isDestroyed||(this.detailsElement.open=!1)}toggle(){this.isDestroyed||(this.detailsElement.open=!this.detailsElement.open)}configure(t){Object.assign(this.options,t),this.handleUpdatePosition()}destroy(){this.disablePortal(),this.detailsElement.removeEventListener("toggle",this.toggleHandler),document.removeEventListener("click",this.clickOutsideHandler),globalThis.removeEventListener("scroll",this.handleUpdatePosition),globalThis.removeEventListener("resize",this.handleUpdatePosition),this.resizeObserver?.disconnect(),this.mutationObserver?.disconnect(),this.isDestroyed=!0}};function w(s,t,e){return new v(s,t,e)}export{v as DropdownAnchor,w as anchorDropdown};
