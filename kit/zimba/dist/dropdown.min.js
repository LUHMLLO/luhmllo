// deno-lint-ignore-file
var u=Object.defineProperty;var m=(o,t,e)=>t in o?u(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var s=(o,t,e)=>m(o,typeof t!="symbol"?t+"":t,e);function b(o,t){let e,r,i=function(...n){e||(o.apply(this,n),e=!0,r=setTimeout(()=>{e=!1,r=void 0},t))};return i.cancel=()=>{r!==void 0&&(clearTimeout(r),r=void 0),e=!1},i}var c=class{constructor(t,e,r={}){s(this,"detailsElement");s(this,"dropdownContent");s(this,"trigger");s(this,"options");s(this,"resizeObserver");s(this,"mutationObserver");s(this,"intersectionObserver");s(this,"clickOutsideHandler");s(this,"toggleHandler");s(this,"throttledUpdate");s(this,"animationFrameId");s(this,"lastTriggerRect");s(this,"isDestroyed",!1);s(this,"isObserversSetup",!1);s(this,"originalParent",null);s(this,"originalNextSibling",null);s(this,"isPortaled",!1);if(this.detailsElement=t,this.dropdownContent=e,this.trigger=t.querySelector("summary"),!this.trigger)throw new Error("DropdownAnchor: No <summary> element found in <details>");this.options={preferredY:"bottom",preferredX:"left",viewportMargin:5,gap:5,animated:!0,portal:!1,portalTo:document.body,...r},this.clickOutsideHandler=this.handleClickOutside.bind(this),this.toggleHandler=this.handleToggle.bind(this),this.throttledUpdate=b(this.updatePosition.bind(this),16),this.initializeDropdown(),this.setupObserversLazy()}initializeDropdown(){this.options.animated||(this.dropdownContent.style.transition="none"),this.options.portal&&(this.originalParent=this.dropdownContent.parentElement,this.originalNextSibling=this.dropdownContent.nextElementSibling),this.detailsElement.addEventListener("toggle",this.toggleHandler,{passive:!0}),this.detailsElement.open&&requestAnimationFrame(()=>this.throttledUpdate())}enablePortal(){!this.options.portal||this.isPortaled||(this.options.portalTo.appendChild(this.dropdownContent),this.isPortaled=!0)}disablePortal(){!this.options.portal||!this.isPortaled||!this.originalParent||(this.originalNextSibling&&this.originalNextSibling.parentNode===this.originalParent?this.originalParent.insertBefore(this.dropdownContent,this.originalNextSibling):this.originalParent.appendChild(this.dropdownContent),this.isPortaled=!1)}startPositionTracking(){if(this.animationFrameId||this.isDestroyed)return;let t=()=>{if(!this.detailsElement.open||this.isDestroyed){this.animationFrameId=void 0,this.lastTriggerRect=void 0;return}let e=this.trigger.getBoundingClientRect();(!this.lastTriggerRect||Math.abs(this.lastTriggerRect.x-e.x)>.5||Math.abs(this.lastTriggerRect.y-e.y)>.5||Math.abs(this.lastTriggerRect.width-e.width)>.5||Math.abs(this.lastTriggerRect.height-e.height)>.5)&&(this.lastTriggerRect||(this.lastTriggerRect=new DOMRect),this.lastTriggerRect.x=e.x,this.lastTriggerRect.y=e.y,this.lastTriggerRect.width=e.width,this.lastTriggerRect.height=e.height,this.updatePosition()),this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}stopPositionTracking(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=void 0),this.lastTriggerRect=void 0}handleToggle(t){this.detailsElement.open?(this.enablePortal(),this.startPositionTracking(),this.setupObserversLazy(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.throttledUpdate()})}),document.addEventListener("click",this.clickOutsideHandler,{passive:!0})):(this.stopPositionTracking(),document.removeEventListener("click",this.clickOutsideHandler),this.disablePortal())}handleClickOutside(t){let e=t.target;e&&!this.detailsElement.contains(e)&&!this.dropdownContent.contains(e)&&(this.detailsElement.open=!1)}calculatePosition(){let t=this.trigger.getBoundingClientRect(),e=this.dropdownContent.getBoundingClientRect(),r={width:globalThis.innerWidth,height:globalThis.innerHeight},i=0,n=0,h=this.options.preferredY,l=this.options.preferredX,a=e.width>0?e.width:200,d=e.height>0?e.height:200,v=r.height-t.bottom-this.options.viewportMargin,g=t.top-this.options.viewportMargin;switch(this.options.preferredY==="bottom"?v>=d+this.options.gap?(n=t.bottom+this.options.gap,h="bottom"):g>=d+this.options.gap?(n=t.top-d-this.options.gap,h="top"):v>g?(n=t.bottom+this.options.gap,h="bottom"):(n=Math.max(this.options.viewportMargin,t.top-d-this.options.gap),h="top"):g>=d+this.options.gap?(n=t.top-d-this.options.gap,h="top"):(n=t.bottom+this.options.gap,h="bottom"),this.options.preferredX){case"left":if(i=t.left,i+a>r.width-this.options.viewportMargin){let p=t.right-a;p>=this.options.viewportMargin?(i=p,l="right"):(i=r.width-a-this.options.viewportMargin,l="right")}break;case"right":if(i=t.right-a,i<this.options.viewportMargin){let p=t.left;p+a<=r.width-this.options.viewportMargin?(i=p,l="left"):(i=this.options.viewportMargin,l="left")}break;case"center":i=t.left+(t.width-a)/2,i<this.options.viewportMargin?(i=this.options.viewportMargin,l="left"):i+a>r.width-this.options.viewportMargin?(i=r.width-a-this.options.viewportMargin,l="right"):l="center";break}return i=Math.max(this.options.viewportMargin,Math.min(i,r.width-a-this.options.viewportMargin)),n=Math.max(this.options.viewportMargin,Math.min(n,r.height-d-this.options.viewportMargin)),{x:i,y:n,placement:{vertical:h,horizontal:l}}}updatePosition(){if(!this.detailsElement.open||this.isDestroyed)return;let t=this.calculatePosition();this.dropdownContent.style.setProperty("--translate-x",`${t.x}px`),this.dropdownContent.style.setProperty("--translate-y",`${t.y}px`)}setupObserversLazy(){this.isObserversSetup||this.isDestroyed||(globalThis.addEventListener("scroll",this.throttledUpdate,{passive:!0}),globalThis.addEventListener("resize",this.throttledUpdate,{passive:!0}),globalThis.ResizeObserver&&(this.resizeObserver=new ResizeObserver(t=>{this.detailsElement.open&&t.length>0&&this.throttledUpdate()}),this.resizeObserver.observe(this.dropdownContent),this.resizeObserver.observe(this.trigger)),globalThis.MutationObserver&&(this.mutationObserver=new MutationObserver(t=>{this.detailsElement.open&&t.length>0&&this.throttledUpdate()}),this.mutationObserver.observe(this.detailsElement,{childList:!0,attributes:!0,attributeFilter:["class","style"],subtree:!1}),this.mutationObserver.observe(this.dropdownContent,{childList:!0,attributes:!0,attributeFilter:["class","style"],subtree:!1}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0})),globalThis.IntersectionObserver&&(this.intersectionObserver=new IntersectionObserver(t=>{this.detailsElement.open&&t.length>0&&this.throttledUpdate()},{threshold:[0,1],rootMargin:"10px"}),this.intersectionObserver.observe(this.trigger)),this.isObserversSetup=!0)}open(){this.isDestroyed||(this.detailsElement.open=!0)}close(){this.isDestroyed||(this.detailsElement.open=!1)}toggle(){this.isDestroyed||(this.detailsElement.open=!this.detailsElement.open)}configure(t){this.isDestroyed||(Object.assign(this.options,t),this.throttledUpdate())}destroy(){this.isDestroyed||(this.stopPositionTracking(),this.disablePortal(),this.detailsElement.removeEventListener("toggle",this.toggleHandler),document.removeEventListener("click",this.clickOutsideHandler),globalThis.removeEventListener("scroll",this.throttledUpdate),globalThis.removeEventListener("resize",this.throttledUpdate),this.throttledUpdate.cancel(),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=void 0),this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=void 0),this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=void 0),this.originalParent=null,this.originalNextSibling=null,this.lastTriggerRect=void 0,this.isDestroyed=!0,this.isObserversSetup=!1)}};function w(o,t,e){return new c(o,t,e)}export{c as DropdownAnchor,w as anchorDropdown};
