// deno-lint-ignore-file
var z=Object.defineProperty;var x=(u,t,e)=>t in u?z(u,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[t]=e;var d=(u,t,e)=>x(u,typeof t!="symbol"?t+"":t,e);var X=class{constructor(t,e,i={}){d(this,"drifterElement");d(this,"boundaryElement");d(this,"options");d(this,"state");d(this,"eventTarget");d(this,"activePointers",new Map);d(this,"pinchState",null);d(this,"inertiaFrameId",null);d(this,"animationFrameId",null);this.drifterElement=t,this.boundaryElement=e,this.options=this.u(i),this.p(),this.eventTarget=this.g(),this.state={primaryPointerId:-1,constraints:{minX:0,maxX:0,minY:0,maxY:0},isDragging:!1,isPinching:!1,movement:{offsetX:0,offsetY:0,startX:0,startY:0,velocityX:0,velocityY:0,lastTime:0},zoom:this.options.zoom.initial},this.b(),this.P(),this.t()}u(t){return{dragSpeed:t.dragSpeed??1.25,inertia:{damping:t.inertia?.damping??.92,threshold:t.inertia?.threshold??1},mode:t.mode??"bounded",boundedTo:t.boundedTo??"center",dragTarget:t.dragTarget??"self",zoom:{enabled:t.zoom?.enabled??!0,initial:t.zoom?.initial??1,min:t.zoom?.min??.5,max:t.zoom?.max??1.5,smoothing:t.zoom?.smoothing??.75,zoomTo:t.zoom?.zoomTo??"cursor"}}}p(){if(!this.drifterElement)throw new Error(`Drifter requires a valid HTMLElement, but received: ${this.drifterElement===null?"null":typeof this.drifterElement}`);if(this.options.mode==="bounded"&&!this.boundaryElement)throw new Error("Bounded mode requires a valid boundary element, but none was provided");this.options.mode==="free"&&this.options.dragTarget==="self"&&(this.boundaryElement=null),console.debug("eventTarget",this.eventTarget)}g(){return this.options.dragTarget==="self"?this.drifterElement:this.boundaryElement}b(){this.i=this.i.bind(this),this.s=this.s.bind(this),this.n=this.n.bind(this),this.o=this.o.bind(this),this.a=this.a.bind(this),this.e=this.e.bind(this),this.l=this.l.bind(this)}P(){this.eventTarget.addEventListener("pointerdown",this.i),this.eventTarget.addEventListener("pointermove",this.s),this.eventTarget.addEventListener("pointerup",this.n),this.eventTarget.addEventListener("pointercancel",this.o),this.eventTarget.addEventListener("pointerleave",this.a),globalThis.addEventListener("blur",this.e),globalThis.addEventListener("visibilitychange",this.e),this.options.zoom.enabled&&this.eventTarget.addEventListener("wheel",this.l,{passive:!1})}D(){this.eventTarget.removeEventListener("pointerdown",this.i),this.eventTarget.removeEventListener("pointermove",this.s),this.eventTarget.removeEventListener("pointerup",this.n),this.eventTarget.removeEventListener("pointercancel",this.o),this.eventTarget.removeEventListener("pointerleave",this.a),globalThis.removeEventListener("blur",this.e),globalThis.removeEventListener("visibilitychange",this.e),this.r(),this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.activePointers.clear()}t(){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.animationFrameId=requestAnimationFrame(()=>{this.drifterElement.style.setProperty("--translate-x",`${this.state.movement.offsetX}px`),this.drifterElement.style.setProperty("--translate-y",`${this.state.movement.offsetY}px`),this.drifterElement.style.setProperty("--translate-z","0px"),this.drifterElement.style.setProperty("--scale",`${this.state.zoom}`),this.animationFrameId=null})}c(t,e){let i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}v(t,e){let i;return this.boundaryElement?i=this.boundaryElement.getBoundingClientRect():i=this.drifterElement.getBoundingClientRect(),{x:(t.x+e.x)/2-i.left,y:(t.y+e.y)/2-i.top}}d(t,e,i=!1){if(this.options.mode==="free"||!this.boundaryElement)return{x:t,y:e};let s=this.drifterElement.clientWidth*this.state.zoom,r=this.drifterElement.clientHeight*this.state.zoom,n=getComputedStyle(this.boundaryElement),o={left:parseFloat(n.paddingLeft),right:parseFloat(n.paddingRight),top:parseFloat(n.paddingTop),bottom:parseFloat(n.paddingBottom)},m=this.boundaryElement.clientWidth-o.left-o.right,a=this.boundaryElement.clientHeight-o.top-o.bottom,l=s/2,h=r/2,c=m/2,T=a/2,p,v,g,f;this.options.boundedTo==="center"?(v=(s-m)/2+c,p=-v,f=(r-a)/2+T,g=-f):(v=c-l,p=-v,f=T-h,g=-f,s>m&&(p=c-l,v=-p),r>a&&(g=T-h,f=-g)),this.state.constraints={minX:p,maxX:v,minY:g,maxY:f};let E=.35;function Y(b,y,P){return b<y?i?y+(b-y)*E:y:b>P?i?P+(b-P)*E:P:b}return{x:Y(t,p,v),y:Y(e,g,f)}}T(){if(this.state.isDragging||this.state.isPinching)return;let{damping:t,threshold:e}=this.options.inertia,i=2e3;this.state.movement.velocityX=Math.max(-i,Math.min(i,this.state.movement.velocityX)),this.state.movement.velocityY=Math.max(-i,Math.min(i,this.state.movement.velocityY));let s=performance.now(),r=n=>{if(!this.inertiaFrameId)return;let o=(n-s)/1e3;if(s=n,this.state.movement.velocityX*=Math.pow(t,o*60),this.state.movement.velocityY*=Math.pow(t,o*60),Math.sqrt(this.state.movement.velocityX**2+this.state.movement.velocityY**2)<e){this.r();return}let a=this.state.movement.velocityX*o,l=this.state.movement.velocityY*o,h=this.d(this.state.movement.offsetX+a,this.state.movement.offsetY+l,!1);this.options.mode==="bounded"&&(h.x!==this.state.movement.offsetX+a&&(this.state.movement.velocityX*=-.3),h.y!==this.state.movement.offsetY+l&&(this.state.movement.velocityY*=-.3)),this.state.movement.offsetX=h.x,this.state.movement.offsetY=h.y,this.t(),this.inertiaFrameId=requestAnimationFrame(r)};this.inertiaFrameId=requestAnimationFrame(r)}r(){this.inertiaFrameId&&(cancelAnimationFrame(this.inertiaFrameId),this.inertiaFrameId=null),this.state.movement.velocityX=0,this.state.movement.velocityY=0}f(){if(this.options.mode==="free")return;let{offsetX:t,offsetY:e}=this.state.movement,i=this.d(t,e,!1);if(Math.abs(i.x-t)<1&&Math.abs(i.y-e)<1)return;let s=performance.now(),r=250,n=o=>{let m=Math.min(1,(o-s)/r),a=m*(2-m);this.state.movement.offsetX=t+(i.x-t)*a,this.state.movement.offsetY=e+(i.y-e)*a,this.t(),m<1&&requestAnimationFrame(n)};requestAnimationFrame(n)}i(t){t.target instanceof HTMLElement&&[this.boundaryElement,this.drifterElement].includes(t.target)&&(this.activePointers.set(t.pointerId,{x:t.clientX,y:t.clientY,timestamp:Date.now()}),this.activePointers.size===1?this.E(t.clientX,t.clientY,t.pointerId):this.activePointers.size===2&&this.options.zoom.enabled&&this.Y(),t.preventDefault())}s(t){this.activePointers.has(t.pointerId)&&this.activePointers.set(t.pointerId,{x:t.clientX,y:t.clientY,timestamp:Date.now()}),this.state.isDragging&&this.state.primaryPointerId===t.pointerId&&this.X(t.clientX,t.clientY),this.state.isPinching&&this.activePointers.size===2&&this.z()}n(t){this.activePointers.delete(t.pointerId),this.state.isPinching&&this.activePointers.size<2?this.m():this.state.isDragging&&this.h(t.pointerId)}o(t){this.activePointers.delete(t.pointerId),this.state.isPinching&&this.m(),this.state.isDragging&&this.h(t.pointerId)}a(t){this.activePointers.delete(t.pointerId),this.state.isDragging&&this.state.primaryPointerId===t.pointerId&&this.h(t.pointerId),this.state.isPinching&&this.activePointers.size<2&&this.m()}e(){this.state.isDragging&&this.h(this.state.primaryPointerId),this.state.isPinching&&this.m(),this.activePointers.clear()}l(t){if(!this.options.zoom.enabled)return;t.preventDefault();let i=1+-t.deltaY/1e3,s=Math.max(this.options.zoom.min,Math.min(this.options.zoom.max,this.state.zoom*i));Math.abs(s-this.state.zoom)<.001||this.I(s,t.clientX,t.clientY)}I(t,e,i,s=!0){let r=this.eventTarget.getBoundingClientRect(),n,o;this.options.zoom.zoomTo==="cursor"?(n=e-r.left,o=i-r.top):(n=this.eventTarget.clientWidth/2,o=this.eventTarget.clientHeight/2);let m=(n-this.eventTarget.clientWidth/2-this.state.movement.offsetX)/this.state.zoom,a=(o-this.eventTarget.clientHeight/2-this.state.movement.offsetY)/this.state.zoom,l=n-this.eventTarget.clientWidth/2-m*t,h=o-this.eventTarget.clientHeight/2-a*t;if(s){let c=this.options.zoom.smoothing;this.state.zoom+=(t-this.state.zoom)*c,this.state.movement.offsetX+=(l-this.state.movement.offsetX)*c,this.state.movement.offsetY+=(h-this.state.movement.offsetY)*c}else this.state.zoom=t,this.state.movement.offsetX=l,this.state.movement.offsetY=h;this.t()}E(t,e,i){this.r(),this.state.isDragging=!0,this.state.movement.startX=t,this.state.movement.startY=e,this.state.primaryPointerId=i,this.state.movement.velocityX=0,this.state.movement.velocityY=0,this.state.movement.lastTime=performance.now(),this.eventTarget.setPointerCapture(i)}Y(){if(!this.options.zoom.enabled)return;let t=Array.from(this.activePointers.values());if(t.length!==2)return;this.r(),this.state.isPinching=!0,this.state.isDragging=!1;let[e,i]=t,s=this.v(e,i),r=(s.x-this.eventTarget.clientWidth/2-this.state.movement.offsetX)/this.state.zoom,n=(s.y-this.eventTarget.clientHeight/2-this.state.movement.offsetY)/this.state.zoom;this.pinchState={initialDistance:this.c(e,i),initialZoom:this.state.zoom,initialCenter:s,initialOffset:{x:this.state.movement.offsetX,y:this.state.movement.offsetY},contentPoint:{x:r,y:n}},this.activePointers.forEach((o,m)=>{this.eventTarget.setPointerCapture(m)})}X(t,e){let i=performance.now(),s=(t-this.state.movement.startX)*this.options.dragSpeed,r=(e-this.state.movement.startY)*this.options.dragSpeed,n=this.state.movement.offsetX,o=this.state.movement.offsetY,m=this.d(this.state.movement.offsetX+s,this.state.movement.offsetY+r,!0);this.state.movement.offsetX=m.x,this.state.movement.offsetY=m.y;let a=i-this.state.movement.lastTime;if(a>5&&a<100){let l=this.state.movement.offsetX-n,h=this.state.movement.offsetY-o;this.state.movement.velocityX=l/a*1e3,this.state.movement.velocityY=h/a*1e3}this.state.movement.startX=t,this.state.movement.startY=e,this.state.movement.lastTime=i,this.t()}z(){if(!this.pinchState||this.activePointers.size!==2)return;let t=Array.from(this.activePointers.values()),[e,i]=t,r=this.c(e,i)/this.pinchState.initialDistance,n=Math.max(this.options.zoom.min,Math.min(this.options.zoom.max,this.pinchState.initialZoom*r)),o=this.v(e,i),m=o.x-this.eventTarget.clientWidth/2-this.pinchState.contentPoint.x*n,a=o.y-this.eventTarget.clientHeight/2-this.pinchState.contentPoint.y*n;this.state.zoom=n,this.state.movement.offsetX=m,this.state.movement.offsetY=a,this.t()}h(t){if(this.state.primaryPointerId!==t)return;this.state.isDragging=!1,this.state.primaryPointerId=-1,Math.sqrt(this.state.movement.velocityX**2+this.state.movement.velocityY**2)>this.options.inertia.threshold?this.T():this.options.mode==="bounded"&&this.f(),this.eventTarget.hasPointerCapture(t)&&this.eventTarget.releasePointerCapture(t)}m(){this.state.isPinching=!1,this.pinchState=null,this.activePointers.forEach((t,e)=>{this.eventTarget.hasPointerCapture(e)&&this.eventTarget.releasePointerCapture(e)}),this.options.mode==="bounded"&&this.f()}};export{X as Drifter};
