// deno-lint-ignore-file
var X=Object.defineProperty;var g=(_,t)=>X(_,"name",{value:t,configurable:!0});var Y=class{static{g(this,"Drifter")}drifterElement;boundaryElement;options;state;eventTarget;activePointers=new Map;pinchState=null;inertiaFrameId=null;animationFrameId=null;constructor(t,i,e={}){this.drifterElement=t,this.boundaryElement=i,this.options=this._applyDefaults(e),this._validateConfiguration(),this.eventTarget=this._resolveEventTarget(),this.state={primaryPointerId:-1,constraints:{minX:0,maxX:0,minY:0,maxY:0},isDragging:!1,isPinching:!1,movement:{offsetX:0,offsetY:0,startX:0,startY:0,velocityX:0,velocityY:0,lastTime:0},zoom:this.options.zoom.initial},this._bindEventHandlers(),this._attachEventListeners(),this._updateTransform()}_applyDefaults(t){return{dragSpeed:t.dragSpeed??1.25,inertia:{damping:t.inertia?.damping??.92,threshold:t.inertia?.threshold??1},mode:t.mode??"bounded",boundedTo:t.boundedTo??"center",dragTarget:t.dragTarget??"self",zoom:{enabled:t.zoom?.enabled??!0,initial:t.zoom?.initial??1,min:t.zoom?.min??.5,max:t.zoom?.max??1.5,smoothing:t.zoom?.smoothing??.75,zoomTo:t.zoom?.zoomTo??"cursor"}}}_validateConfiguration(){if(!this.drifterElement)throw new Error(`Drifter requires a valid HTMLElement, but received: ${this.drifterElement===null?"null":typeof this.drifterElement}`);if(this.options.mode==="bounded"&&!this.boundaryElement)throw new Error("Bounded mode requires a valid boundary element, but none was provided");this.options.mode==="free"&&this.options.dragTarget==="self"&&(this.boundaryElement=null),console.debug("eventTarget",this.eventTarget)}_resolveEventTarget(){return this.options.dragTarget==="self"?this.drifterElement:this.boundaryElement}_bindEventHandlers(){this._handlePointerDown=this._handlePointerDown.bind(this),this._handlePointerMove=this._handlePointerMove.bind(this),this._handlePointerUp=this._handlePointerUp.bind(this),this._handlePointerCancel=this._handlePointerCancel.bind(this),this._handlePointerLeave=this._handlePointerLeave.bind(this),this._handleWindowBlur=this._handleWindowBlur.bind(this),this._handleWheel=this._handleWheel.bind(this)}_attachEventListeners(){this.eventTarget.addEventListener("pointerdown",this._handlePointerDown),this.eventTarget.addEventListener("pointermove",this._handlePointerMove),this.eventTarget.addEventListener("pointerup",this._handlePointerUp),this.eventTarget.addEventListener("pointercancel",this._handlePointerCancel),this.eventTarget.addEventListener("pointerleave",this._handlePointerLeave),globalThis.addEventListener("blur",this._handleWindowBlur),globalThis.addEventListener("visibilitychange",this._handleWindowBlur),this.options.zoom.enabled&&this.eventTarget.addEventListener("wheel",this._handleWheel,{passive:!1})}_detachEventListeners(){this.eventTarget.removeEventListener("pointerdown",this._handlePointerDown),this.eventTarget.removeEventListener("pointermove",this._handlePointerMove),this.eventTarget.removeEventListener("pointerup",this._handlePointerUp),this.eventTarget.removeEventListener("pointercancel",this._handlePointerCancel),this.eventTarget.removeEventListener("pointerleave",this._handlePointerLeave),globalThis.removeEventListener("blur",this._handleWindowBlur),globalThis.removeEventListener("visibilitychange",this._handleWindowBlur),this._stopInertia(),this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.activePointers.clear()}_updateTransform(){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.animationFrameId=requestAnimationFrame(()=>{this.drifterElement.style.setProperty("--translate-x",`${this.state.movement.offsetX}px`),this.drifterElement.style.setProperty("--translate-y",`${this.state.movement.offsetY}px`),this.drifterElement.style.setProperty("--translate-z","0px"),this.drifterElement.style.setProperty("--scale",`${this.state.zoom}`),this.animationFrameId=null})}_getPointerDistance(t,i){let e=t.x-i.x,n=t.y-i.y;return Math.sqrt(e*e+n*n)}_getPointerCenter(t,i){let e;return this.boundaryElement?e=this.boundaryElement.getBoundingClientRect():e=this.drifterElement.getBoundingClientRect(),{x:(t.x+i.x)/2-e.left,y:(t.y+i.y)/2-e.top}}_calculateConstraints(t,i,e=!1){if(this.options.mode==="free"||!this.boundaryElement)return{x:t,y:i};let n=this.drifterElement.clientWidth*this.state.zoom,r=this.drifterElement.clientHeight*this.state.zoom,s=getComputedStyle(this.boundaryElement),o={left:parseFloat(s.paddingLeft),right:parseFloat(s.paddingRight),top:parseFloat(s.paddingTop),bottom:parseFloat(s.paddingBottom)},h=this.boundaryElement.clientWidth-o.left-o.right,a=this.boundaryElement.clientHeight-o.top-o.bottom,l=n/2,m=r/2,d=h/2,y=a/2,f,c,u,v;this.options.boundedTo==="center"?(c=(n-h)/2+d,f=-c,v=(r-a)/2+y,u=-v):(c=d-l,f=-c,v=y-m,u=-v,n>h&&(f=d-l,c=-f),r>a&&(u=y-m,v=-u)),this.state.constraints={minX:f,maxX:c,minY:u,maxY:v};let T=.35;function E(p,b,P){return p<b?e?b+(p-b)*T:b:p>P?e?P+(p-P)*T:P:p}return g(E,"applyElastic"),{x:E(t,f,c),y:E(i,u,v)}}_startInertia(){if(this.state.isDragging||this.state.isPinching)return;let{damping:t,threshold:i}=this.options.inertia,e=2e3;this.state.movement.velocityX=Math.max(-e,Math.min(e,this.state.movement.velocityX)),this.state.movement.velocityY=Math.max(-e,Math.min(e,this.state.movement.velocityY));let n=performance.now(),r=g(s=>{if(!this.inertiaFrameId)return;let o=(s-n)/1e3;if(n=s,this.state.movement.velocityX*=Math.pow(t,o*60),this.state.movement.velocityY*=Math.pow(t,o*60),Math.sqrt(this.state.movement.velocityX**2+this.state.movement.velocityY**2)<i){this._stopInertia();return}let a=this.state.movement.velocityX*o,l=this.state.movement.velocityY*o,m=this._calculateConstraints(this.state.movement.offsetX+a,this.state.movement.offsetY+l,!1);this.options.mode==="bounded"&&(m.x!==this.state.movement.offsetX+a&&(this.state.movement.velocityX*=-.3),m.y!==this.state.movement.offsetY+l&&(this.state.movement.velocityY*=-.3)),this.state.movement.offsetX=m.x,this.state.movement.offsetY=m.y,this._updateTransform(),this.inertiaFrameId=requestAnimationFrame(r)},"step");this.inertiaFrameId=requestAnimationFrame(r)}_stopInertia(){this.inertiaFrameId&&(cancelAnimationFrame(this.inertiaFrameId),this.inertiaFrameId=null),this.state.movement.velocityX=0,this.state.movement.velocityY=0}_bounceBackToBounds(){if(this.options.mode==="free")return;let{offsetX:t,offsetY:i}=this.state.movement,e=this._calculateConstraints(t,i,!1);if(Math.abs(e.x-t)<1&&Math.abs(e.y-i)<1)return;let n=performance.now(),r=250,s=g(o=>{let h=Math.min(1,(o-n)/r),a=h*(2-h);this.state.movement.offsetX=t+(e.x-t)*a,this.state.movement.offsetY=i+(e.y-i)*a,this._updateTransform(),h<1&&requestAnimationFrame(s)},"animate");requestAnimationFrame(s)}_handlePointerDown(t){t.target instanceof HTMLElement&&[this.boundaryElement,this.drifterElement].includes(t.target)&&(this.activePointers.set(t.pointerId,{x:t.clientX,y:t.clientY,timestamp:Date.now()}),this.activePointers.size===1?this._beginDrag(t.clientX,t.clientY,t.pointerId):this.activePointers.size===2&&this.options.zoom.enabled&&this._beginPinch(),t.preventDefault())}_handlePointerMove(t){this.activePointers.has(t.pointerId)&&this.activePointers.set(t.pointerId,{x:t.clientX,y:t.clientY,timestamp:Date.now()}),this.state.isDragging&&this.state.primaryPointerId===t.pointerId&&this._processDragMovement(t.clientX,t.clientY),this.state.isPinching&&this.activePointers.size===2&&this._processPinchMovement()}_handlePointerUp(t){this.activePointers.delete(t.pointerId),this.state.isPinching&&this.activePointers.size<2?this._endPinch():this.state.isDragging&&this._endDrag(t.pointerId)}_handlePointerCancel(t){this.activePointers.delete(t.pointerId),this.state.isPinching&&this._endPinch(),this.state.isDragging&&this._endDrag(t.pointerId)}_handlePointerLeave(t){this.activePointers.delete(t.pointerId),this.state.isDragging&&this.state.primaryPointerId===t.pointerId&&this._endDrag(t.pointerId),this.state.isPinching&&this.activePointers.size<2&&this._endPinch()}_handleWindowBlur(){this.state.isDragging&&this._endDrag(this.state.primaryPointerId),this.state.isPinching&&this._endPinch(),this.activePointers.clear()}_handleWheel(t){if(!this.options.zoom.enabled)return;t.preventDefault();let e=1+-t.deltaY/1e3,n=Math.max(this.options.zoom.min,Math.min(this.options.zoom.max,this.state.zoom*e));Math.abs(n-this.state.zoom)<.001||this._performZoom(n,t.clientX,t.clientY)}_performZoom(t,i,e,n=!0){let r=this.eventTarget.getBoundingClientRect(),s,o;this.options.zoom.zoomTo==="cursor"?(s=i-r.left,o=e-r.top):(s=this.eventTarget.clientWidth/2,o=this.eventTarget.clientHeight/2);let h=(s-this.eventTarget.clientWidth/2-this.state.movement.offsetX)/this.state.zoom,a=(o-this.eventTarget.clientHeight/2-this.state.movement.offsetY)/this.state.zoom,l=s-this.eventTarget.clientWidth/2-h*t,m=o-this.eventTarget.clientHeight/2-a*t;if(n){let d=this.options.zoom.smoothing;this.state.zoom+=(t-this.state.zoom)*d,this.state.movement.offsetX+=(l-this.state.movement.offsetX)*d,this.state.movement.offsetY+=(m-this.state.movement.offsetY)*d}else this.state.zoom=t,this.state.movement.offsetX=l,this.state.movement.offsetY=m;this._updateTransform()}_beginDrag(t,i,e){this._stopInertia(),this.state.isDragging=!0,this.state.movement.startX=t,this.state.movement.startY=i,this.state.primaryPointerId=e,this.state.movement.velocityX=0,this.state.movement.velocityY=0,this.state.movement.lastTime=performance.now(),this.eventTarget.setPointerCapture(e)}_beginPinch(){if(!this.options.zoom.enabled)return;let t=Array.from(this.activePointers.values());if(t.length!==2)return;this._stopInertia(),this.state.isPinching=!0,this.state.isDragging=!1;let[i,e]=t,n=this._getPointerCenter(i,e),r=(n.x-this.eventTarget.clientWidth/2-this.state.movement.offsetX)/this.state.zoom,s=(n.y-this.eventTarget.clientHeight/2-this.state.movement.offsetY)/this.state.zoom;this.pinchState={initialDistance:this._getPointerDistance(i,e),initialZoom:this.state.zoom,initialCenter:n,initialOffset:{x:this.state.movement.offsetX,y:this.state.movement.offsetY},contentPoint:{x:r,y:s}},this.activePointers.forEach((o,h)=>{this.eventTarget.setPointerCapture(h)})}_processDragMovement(t,i){let e=performance.now(),n=(t-this.state.movement.startX)*this.options.dragSpeed,r=(i-this.state.movement.startY)*this.options.dragSpeed,s=this.state.movement.offsetX,o=this.state.movement.offsetY,h=this._calculateConstraints(this.state.movement.offsetX+n,this.state.movement.offsetY+r,!0);this.state.movement.offsetX=h.x,this.state.movement.offsetY=h.y;let a=e-this.state.movement.lastTime;if(a>5&&a<100){let l=this.state.movement.offsetX-s,m=this.state.movement.offsetY-o;this.state.movement.velocityX=l/a*1e3,this.state.movement.velocityY=m/a*1e3}this.state.movement.startX=t,this.state.movement.startY=i,this.state.movement.lastTime=e,this._updateTransform()}_processPinchMovement(){if(!this.pinchState||this.activePointers.size!==2)return;let t=Array.from(this.activePointers.values()),[i,e]=t,r=this._getPointerDistance(i,e)/this.pinchState.initialDistance,s=Math.max(this.options.zoom.min,Math.min(this.options.zoom.max,this.pinchState.initialZoom*r)),o=this._getPointerCenter(i,e),h=o.x-this.eventTarget.clientWidth/2-this.pinchState.contentPoint.x*s,a=o.y-this.eventTarget.clientHeight/2-this.pinchState.contentPoint.y*s;this.state.zoom=s,this.state.movement.offsetX=h,this.state.movement.offsetY=a,this._updateTransform()}_endDrag(t){if(this.state.primaryPointerId!==t)return;this.state.isDragging=!1,this.state.primaryPointerId=-1,Math.sqrt(this.state.movement.velocityX**2+this.state.movement.velocityY**2)>this.options.inertia.threshold?this._startInertia():this.options.mode==="bounded"&&this._bounceBackToBounds(),this.eventTarget.hasPointerCapture(t)&&this.eventTarget.releasePointerCapture(t)}_endPinch(){this.state.isPinching=!1,this.pinchState=null,this.activePointers.forEach((t,i)=>{this.eventTarget.hasPointerCapture(i)&&this.eventTarget.releasePointerCapture(i)}),this.options.mode==="bounded"&&this._bounceBackToBounds()}};export{Y as Drifter};
