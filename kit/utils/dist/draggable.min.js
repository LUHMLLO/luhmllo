// deno-lint-ignore-file
var E=class{drifterElement;boundaryElement;options;state;eventTarget;activePointers=new Map;pinchState=null;inertiaFrameId=null;animationFrameId=null;constructor(t,i,e={}){this.drifterElement=t,this.boundaryElement=i,this.options=this.u(e),this.p(),this.eventTarget=this.g(),this.state={primaryPointerId:-1,constraints:{minX:0,maxX:0,minY:0,maxY:0},isDragging:!1,isPinching:!1,movement:{offsetX:0,offsetY:0,startX:0,startY:0,velocityX:0,velocityY:0,lastTime:0},zoom:this.options.zoom.initial},this.b(),this.P(),this.t()}u(t){return{dragSpeed:t.dragSpeed??1.25,inertia:{damping:t.inertia?.damping??.92,threshold:t.inertia?.threshold??1},mode:t.mode??"bounded",boundedTo:t.boundedTo??"center",dragTarget:t.dragTarget??"self",zoom:{enabled:t.zoom?.enabled??!0,initial:t.zoom?.initial??1,min:t.zoom?.min??.5,max:t.zoom?.max??1.5,smoothing:t.zoom?.smoothing??.75,zoomTo:t.zoom?.zoomTo??"cursor"}}}p(){if(!this.drifterElement)throw new Error(`Drifter requires a valid HTMLElement, but received: ${this.drifterElement===null?"null":typeof this.drifterElement}`);if(this.options.mode==="bounded"&&!this.boundaryElement)throw new Error("Bounded mode requires a valid boundary element, but none was provided");this.options.mode==="free"&&this.options.dragTarget==="self"&&(this.boundaryElement=null),console.debug("eventTarget",this.eventTarget)}g(){return this.options.dragTarget==="self"?this.drifterElement:this.boundaryElement}b(){this.i=this.i.bind(this),this.s=this.s.bind(this),this.n=this.n.bind(this),this.o=this.o.bind(this),this.a=this.a.bind(this),this.e=this.e.bind(this),this.l=this.l.bind(this)}P(){this.eventTarget.addEventListener("pointerdown",this.i),this.eventTarget.addEventListener("pointermove",this.s),this.eventTarget.addEventListener("pointerup",this.n),this.eventTarget.addEventListener("pointercancel",this.o),this.eventTarget.addEventListener("pointerleave",this.a),globalThis.addEventListener("blur",this.e),globalThis.addEventListener("visibilitychange",this.e),this.options.zoom.enabled&&this.eventTarget.addEventListener("wheel",this.l,{passive:!1})}D(){this.eventTarget.removeEventListener("pointerdown",this.i),this.eventTarget.removeEventListener("pointermove",this.s),this.eventTarget.removeEventListener("pointerup",this.n),this.eventTarget.removeEventListener("pointercancel",this.o),this.eventTarget.removeEventListener("pointerleave",this.a),globalThis.removeEventListener("blur",this.e),globalThis.removeEventListener("visibilitychange",this.e),this.r(),this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.activePointers.clear()}t(){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.animationFrameId=requestAnimationFrame(()=>{this.drifterElement.style.setProperty("--translate-x",`${this.state.movement.offsetX}px`),this.drifterElement.style.setProperty("--translate-y",`${this.state.movement.offsetY}px`),this.drifterElement.style.setProperty("--translate-z","0px"),this.drifterElement.style.setProperty("--scale",`${this.state.zoom}`),this.animationFrameId=null})}v(t,i){let e=t.x-i.x,s=t.y-i.y;return Math.sqrt(e*e+s*s)}c(t,i){let e;return this.boundaryElement?e=this.boundaryElement.getBoundingClientRect():e=this.drifterElement.getBoundingClientRect(),{x:(t.x+i.x)/2-e.left,y:(t.y+i.y)/2-e.top}}d(t,i,e=!1){if(this.options.mode==="free"||!this.boundaryElement)return{x:t,y:i};let s=this.drifterElement.clientWidth*this.state.zoom,r=this.drifterElement.clientHeight*this.state.zoom,n=getComputedStyle(this.boundaryElement),o={left:parseFloat(n.paddingLeft),right:parseFloat(n.paddingRight),top:parseFloat(n.paddingTop),bottom:parseFloat(n.paddingBottom)},m=this.boundaryElement.clientWidth-o.left-o.right,a=this.boundaryElement.clientHeight-o.top-o.bottom,l=s/2,h=r/2,d=m/2,y=a/2,f,v,u,c;this.options.boundedTo==="center"?(v=(s-m)/2+d,f=-v,c=(r-a)/2+y,u=-c):(v=d-l,f=-v,c=y-h,u=-c,s>m&&(f=d-l,v=-f),r>a&&(u=y-h,c=-u)),this.state.constraints={minX:f,maxX:v,minY:u,maxY:c};let P=.35;function T(p,g,b){return p<g?e?g+(p-g)*P:g:p>b?e?b+(p-b)*P:b:p}return{x:T(t,f,v),y:T(i,u,c)}}T(){if(this.state.isDragging||this.state.isPinching)return;let{damping:t,threshold:i}=this.options.inertia,e=2e3;this.state.movement.velocityX=Math.max(-e,Math.min(e,this.state.movement.velocityX)),this.state.movement.velocityY=Math.max(-e,Math.min(e,this.state.movement.velocityY));let s=performance.now(),r=n=>{if(!this.inertiaFrameId)return;let o=(n-s)/1e3;if(s=n,this.state.movement.velocityX*=Math.pow(t,o*60),this.state.movement.velocityY*=Math.pow(t,o*60),Math.sqrt(this.state.movement.velocityX**2+this.state.movement.velocityY**2)<i){this.r();return}let a=this.state.movement.velocityX*o,l=this.state.movement.velocityY*o,h=this.d(this.state.movement.offsetX+a,this.state.movement.offsetY+l,!1);this.options.mode==="bounded"&&(h.x!==this.state.movement.offsetX+a&&(this.state.movement.velocityX*=-.3),h.y!==this.state.movement.offsetY+l&&(this.state.movement.velocityY*=-.3)),this.state.movement.offsetX=h.x,this.state.movement.offsetY=h.y,this.t(),this.inertiaFrameId=requestAnimationFrame(r)};this.inertiaFrameId=requestAnimationFrame(r)}r(){this.inertiaFrameId&&(cancelAnimationFrame(this.inertiaFrameId),this.inertiaFrameId=null),this.state.movement.velocityX=0,this.state.movement.velocityY=0}f(){if(this.options.mode==="free")return;let{offsetX:t,offsetY:i}=this.state.movement,e=this.d(t,i,!1);if(Math.abs(e.x-t)<1&&Math.abs(e.y-i)<1)return;let s=performance.now(),r=250,n=o=>{let m=Math.min(1,(o-s)/r),a=m*(2-m);this.state.movement.offsetX=t+(e.x-t)*a,this.state.movement.offsetY=i+(e.y-i)*a,this.t(),m<1&&requestAnimationFrame(n)};requestAnimationFrame(n)}i(t){t.target instanceof HTMLElement&&(this.activePointers.set(t.pointerId,{x:t.clientX,y:t.clientY,timestamp:Date.now()}),this.activePointers.size===1?this.E(t.clientX,t.clientY,t.pointerId):this.activePointers.size===2&&this.options.zoom.enabled&&this.Y(),t.preventDefault())}s(t){this.activePointers.has(t.pointerId)&&this.activePointers.set(t.pointerId,{x:t.clientX,y:t.clientY,timestamp:Date.now()}),this.state.isDragging&&this.state.primaryPointerId===t.pointerId&&this.X(t.clientX,t.clientY),this.state.isPinching&&this.activePointers.size===2&&this.z()}n(t){this.activePointers.delete(t.pointerId),this.state.isPinching&&this.activePointers.size<2?this.m():this.state.isDragging&&this.h(t.pointerId)}o(t){this.activePointers.delete(t.pointerId),this.state.isPinching&&this.m(),this.state.isDragging&&this.h(t.pointerId)}a(t){this.activePointers.delete(t.pointerId),this.state.isDragging&&this.state.primaryPointerId===t.pointerId&&this.h(t.pointerId),this.state.isPinching&&this.activePointers.size<2&&this.m()}e(){this.state.isDragging&&this.h(this.state.primaryPointerId),this.state.isPinching&&this.m(),this.activePointers.clear()}l(t){if(!this.options.zoom.enabled)return;t.preventDefault();let e=1+-t.deltaY/1e3,s=Math.max(this.options.zoom.min,Math.min(this.options.zoom.max,this.state.zoom*e));Math.abs(s-this.state.zoom)<.001||this.I(s,t.clientX,t.clientY)}I(t,i,e,s=!0){let r=this.eventTarget.getBoundingClientRect(),n,o;this.options.zoom.zoomTo==="cursor"?(n=i-r.left,o=e-r.top):(n=this.eventTarget.clientWidth/2,o=this.eventTarget.clientHeight/2);let m=(n-this.eventTarget.clientWidth/2-this.state.movement.offsetX)/this.state.zoom,a=(o-this.eventTarget.clientHeight/2-this.state.movement.offsetY)/this.state.zoom,l=n-this.eventTarget.clientWidth/2-m*t,h=o-this.eventTarget.clientHeight/2-a*t;if(s){let d=this.options.zoom.smoothing;this.state.zoom+=(t-this.state.zoom)*d,this.state.movement.offsetX+=(l-this.state.movement.offsetX)*d,this.state.movement.offsetY+=(h-this.state.movement.offsetY)*d}else this.state.zoom=t,this.state.movement.offsetX=l,this.state.movement.offsetY=h;this.t()}E(t,i,e){this.r(),this.state.isDragging=!0,this.state.movement.startX=t,this.state.movement.startY=i,this.state.primaryPointerId=e,this.state.movement.velocityX=0,this.state.movement.velocityY=0,this.state.movement.lastTime=performance.now(),this.eventTarget.setPointerCapture(e)}Y(){if(!this.options.zoom.enabled)return;let t=Array.from(this.activePointers.values());if(t.length!==2)return;this.r(),this.state.isPinching=!0,this.state.isDragging=!1;let[i,e]=t,s=this.c(i,e),r=(s.x-this.eventTarget.clientWidth/2-this.state.movement.offsetX)/this.state.zoom,n=(s.y-this.eventTarget.clientHeight/2-this.state.movement.offsetY)/this.state.zoom;this.pinchState={initialDistance:this.v(i,e),initialZoom:this.state.zoom,initialCenter:s,initialOffset:{x:this.state.movement.offsetX,y:this.state.movement.offsetY},contentPoint:{x:r,y:n}},this.activePointers.forEach((o,m)=>{this.eventTarget.setPointerCapture(m)})}X(t,i){let e=performance.now(),s=(t-this.state.movement.startX)*this.options.dragSpeed,r=(i-this.state.movement.startY)*this.options.dragSpeed,n=this.state.movement.offsetX,o=this.state.movement.offsetY,m=this.d(this.state.movement.offsetX+s,this.state.movement.offsetY+r,!0);this.state.movement.offsetX=m.x,this.state.movement.offsetY=m.y;let a=e-this.state.movement.lastTime;if(a>5&&a<100){let l=this.state.movement.offsetX-n,h=this.state.movement.offsetY-o;this.state.movement.velocityX=l/a*1e3,this.state.movement.velocityY=h/a*1e3}this.state.movement.startX=t,this.state.movement.startY=i,this.state.movement.lastTime=e,this.t()}z(){if(!this.pinchState||this.activePointers.size!==2)return;let t=Array.from(this.activePointers.values()),[i,e]=t,r=this.v(i,e)/this.pinchState.initialDistance,n=Math.max(this.options.zoom.min,Math.min(this.options.zoom.max,this.pinchState.initialZoom*r)),o=this.c(i,e),m=o.x-this.eventTarget.clientWidth/2-this.pinchState.contentPoint.x*n,a=o.y-this.eventTarget.clientHeight/2-this.pinchState.contentPoint.y*n;this.state.zoom=n,this.state.movement.offsetX=m,this.state.movement.offsetY=a,this.t()}h(t){if(this.state.primaryPointerId!==t)return;this.state.isDragging=!1,this.state.primaryPointerId=-1,Math.sqrt(this.state.movement.velocityX**2+this.state.movement.velocityY**2)>this.options.inertia.threshold?this.T():this.options.mode==="bounded"&&this.f(),this.eventTarget.hasPointerCapture(t)&&this.eventTarget.releasePointerCapture(t)}m(){this.state.isPinching=!1,this.pinchState=null,this.activePointers.forEach((t,i)=>{this.eventTarget.hasPointerCapture(i)&&this.eventTarget.releasePointerCapture(i)}),this.options.mode==="bounded"&&this.f()}};export{E as Drifter};
