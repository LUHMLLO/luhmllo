---
import { Image } from 'astro:assets';
import AssetContactBackground from '../assets/contactbackground.png';
import { getBasePath } from 'src/utils/routeSegments';

const basePath = getBasePath(Astro.url.pathname, 2);
---

<section
	id='contact'
	data-is='grid'
	data-layout='expand'
	style='--cols: 2; --gap: calc(var(--xl) * 2);'>
	<figure data-is='background'>
		<Image
			src={AssetContactBackground}
			alt='contact section background'
			decoding='async'
			loading='eager'
			style='object-position: 1% 0%;'
		/>
	</figure>

	<hr style='height: 0; width: 0;' />

	<form
		id='contact__form'
		action={`${basePath}/api/methods`}
		method='POST'
		data-is='grid'
		style='--cols: 1; --gap: calc(var(--xl) * 2);'
		autocomplete='on'>
		<header data-is='stack' style='gap: var(--xs);'>
			<h3>Request a Free<br />Consultation or Quote</h3>
			<p>
				Fill out this form for a free consultation or product quote.<br />
				We'll get back to you shortly.
			</p>
		</header>

		<fieldset data-is='grid' style='--cols: 2; --gap: var(--xl);'>
			<label for='first_name' data-is='field'>
				<span data-part='label'> First Name </span>
				<input
					type='text'
					id='first_name'
					name='first_name'
					autocomplete='given-name'
					placeholder='John'
				/>
			</label>

			<label for='last_name' data-is='field'>
				<span data-part='label'> Last Name </span>
				<input
					type='text'
					id='last_name'
					name='last_name'
					autocomplete='family-name'
					placeholder='Doe'
				/>
			</label>

			<label for='phone_number' data-is='field'>
				<span data-part='label'> Phone </span>
				<input
					type='tel'
					id='phone_number'
					name='phone_number'
					inputmode='tel'
					pattern='\d{3}[-.\s]?\d{3}[-.\s]?\d{4}'
					autocomplete='tel'
					placeholder='123-456-7890'
				/>
			</label>

			<label for='email' data-is='field'>
				<span data-part='label'> Email </span>
				<input
					type='email'
					id='email'
					name='email'
					autocomplete='email'
					placeholder='you@example.com'
				/>
			</label>

			<label for='address' data-is='field'>
				<span data-part='label'> Address </span>
				<input
					type='text'
					id='address'
					name='address'
					autocomplete='street-address'
					placeholder='123 Main St'
				/>
			</label>

			<label for='city' data-is='field'>
				<span data-part='label'>City</span>
				<select id='city' name='city' autocomplete='address-level2'>
					<option value=''>Select a city</option>
					<option value='some city'>Some city</option>
				</select>
			</label>

			<label for='state' data-is='field'>
				<span data-part='label'>State</span>
				<select id='state' name='state' autocomplete='address-level1'>
					<option value=''>Select a state</option>
					<option value='AL'>Alabama</option>
					<option value='AK'>Alaska</option>
					<option value='AZ'>Arizona</option>
					<option value='AR'>Arkansas</option>
					<option value='CA'>California</option>
					<option value='CO'>Colorado</option>
					<option value='CT'>Connecticut</option>
					<option value='DE'>Delaware</option>
					<option value='FL'>Florida</option>
					<option value='GA'>Georgia</option>
					<option value='HI'>Hawaii</option>
					<option value='ID'>Idaho</option>
					<option value='IL'>Illinois</option>
					<option value='IN'>Indiana</option>
					<option value='IA'>Iowa</option>
					<option value='KS'>Kansas</option>
					<option value='KY'>Kentucky</option>
					<option value='LA'>Louisiana</option>
					<option value='ME'>Maine</option>
					<option value='MD'>Maryland</option>
					<option value='MA'>Massachusetts</option>
					<option value='MI'>Michigan</option>
					<option value='MN'>Minnesota</option>
					<option value='MS'>Mississippi</option>
					<option value='MO'>Missouri</option>
					<option value='MT'>Montana</option>
					<option value='NE'>Nebraska</option>
					<option value='NV'>Nevada</option>
					<option value='NH'>New Hampshire</option>
					<option value='NJ'>New Jersey</option>
					<option value='NM'>New Mexico</option>
					<option value='NY'>New York</option>
					<option value='NC'>North Carolina</option>
					<option value='ND'>North Dakota</option>
					<option value='OH'>Ohio</option>
					<option value='OK'>Oklahoma</option>
					<option value='OR'>Oregon</option>
					<option value='PA'>Pennsylvania</option>
					<option value='RI'>Rhode Island</option>
					<option value='SC'>South Carolina</option>
					<option value='SD'>South Dakota</option>
					<option value='TN'>Tennessee</option>
					<option value='TX'>Texas</option>
					<option value='UT'>Utah</option>
					<option value='VT'>Vermont</option>
					<option value='VA'>Virginia</option>
					<option value='WA'>Washington</option>
					<option value='WV'>West Virginia</option>
					<option value='WI'>Wisconsin</option>
					<option value='WY'>Wyoming</option>
				</select>
			</label>

			<label for='zip' data-is='field'>
				<span data-part='label'>ZIP Code</span>
				<input
					type='text'
					id='zip'
					name='zip'
					inputmode='numeric'
					autocomplete='postal-code'
					placeholder='92101'
				/>
			</label>

			<label for='product_interest' data-is='field'>
				<span data-part='label'>Which products are of interest?</span>
				<select id='product_interest' name='product_interest'>
					<option value=''>Select a product</option>
					<option value='whole_house'>Whole House Filtration</option>
					<option value='under_sink'>Under-Sink Systems</option>
					<option value='softeners'>Water Softeners</option>
					<option value='reverse_osmosis'>Reverse Osmosis</option>
					<option value='consultation'>Just a Consultation</option>
				</select>
			</label>

			<label for='contact_time' data-is='field'>
				<span data-part='label'>Preferred contact time</span>
				<select id='contact_time' name='contact_time'>
					<option value=''>Select a time</option>
					<option value='morning'>Morning (8am–12pm)</option>
					<option value='afternoon'>Afternoon (12pm–4pm)</option>
					<option value='evening'>Evening (4pm–8pm)</option>
				</select>
			</label>
		</fieldset>

		<footer>
			<button
				id='contact__formstatus'
				aria-live='polite'
				type='submit'
				data-is='button'
				style='width: 100%;'>
				Submit Request
			</button>
		</footer>
	</form>

	<script type='module' is:inline>
		window.addEventListener('DOMContentLoaded', () => {
			const form = document.querySelector('#contact__form');
			const status = document.querySelector('#contact__formstatus');
			if (!form || !status) return;

			form.addEventListener('submit', async (e) => {
				e.preventDefault();

				const formData = new FormData(form);

				try {
					const response = await fetch(form.action, {
						method: form.method,
						body: formData,
						headers: {
							Accept: 'application/json',
						},
					});

					if (!response.ok) throw new Error('Network error');

					const result = await response.json();
					console.log(result);
					status.textContent = result.message || 'Success!';
					setTimeout(() => {
						status.textContent = 'Submit Request';
					}, 2000);
					form.reset();
				} catch (err) {
					status.textContent = 'Error submitting form.';
					console.log(err);
				}
			});
		});
	</script>

	<style lang='css' is:inline>
		@scope (#contact) {
			:scope {
				overflow: clip;
				padding-block: calc(var(--xl) * 2);
				position: relative;

				#contact__form {
					background-color: hsl(from var(--clr-background__raised) h s l / 50%);
					backdrop-filter: blur(5ex);
					border-radius: var(--sm);
					padding: calc(var(--nm) * 2) var(--xl);

					& > fieldset {
						& > label {
							& > :where(input, select, [data-is='input']) {
								background-color: hsl(
									from var(--clr-background__raised) h s l / 50%
								);

								&:not(:focus-visible) {
									outline-color: transparent;
								}
							}
						}
					}
				}

				@container xwindow (width < 896px) {
					hr {
						display: none;
					}

					#contact__form {
						grid-column: 1/-1;
					}
				}
			}
		}
	</style>
</section>
